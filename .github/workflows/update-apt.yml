name: Update APT Repository

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (without v prefix, e.g. 0.1.0)'
        required: true

jobs:
  update-apt-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y reprepro

      - name: Configure AWS CLI for R2
        run: |
          aws configure set aws_access_key_id "${{ secrets.R2_ACCESS_KEY_ID }}"
          aws configure set aws_secret_access_key "${{ secrets.R2_SECRET_ACCESS_KEY }}"
          aws configure set default.region auto
        env:
          AWS_DEFAULT_OUTPUT: json

      - name: Import GPG signing key
        run: echo "${{ secrets.APT_GPG_PRIVATE_KEY }}" | gpg --batch --import

      - name: Download .deb from GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ inputs.version }}"
          mkdir -p artifacts
          gh release download "v${VERSION}" --pattern "*.deb" --dir artifacts

      - name: Sync existing APT repo from R2
        run: |
          mkdir -p repo
          aws s3 sync "s3://mcpmux-apt/" repo/ \
            --endpoint-url "${{ secrets.R2_ENDPOINT }}" \
            || echo "No existing repo (first run)"

      - name: Update APT repo with new packages
        run: |
          cp -r scripts/apt-repo/conf repo/

          for deb in artifacts/*.deb; do
            echo "Adding: $deb"
            reprepro -b repo --section utils --priority optional includedeb stable "$deb"
          done

          gpg --armor --export hello@mcpmux.com > repo/key.gpg

      - name: Sync APT repo back to R2
        run: |
          aws s3 sync repo/ "s3://mcpmux-apt/" \
            --endpoint-url "${{ secrets.R2_ENDPOINT }}" \
            --delete
