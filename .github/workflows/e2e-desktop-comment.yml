# Trigger desktop E2E tests when someone comments /e2e-desktop on a PR, or manually.
# Calls the reusable e2e-desktop workflow with the PR head ref.

name: E2E Desktop (Comment Trigger)

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr:
        description: PR number to run E2E on (required for manual run)
        required: true
        type: number

jobs:
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check comment trigger
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const trigger = '/e2e-desktop';
            if (context.eventName === 'workflow_dispatch') {
              core.setOutput('should_run', 'true');
              return;
            }
            if (context.eventName === 'issue_comment' && context.payload.issue?.pull_request) {
              const body = context.payload.comment?.body || '';
              core.setOutput('should_run', body.includes(trigger) ? 'true' : 'false');
              return;
            }
            core.setOutput('should_run', 'false');

  get-pr-ref:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      ref: ${{ steps.pr.outputs.sha }}
    steps:
      - name: Get PR head ref
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.eventName === 'workflow_dispatch'
              ? context.payload.inputs.pr
              : context.issue.number;
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: Number(prNumber),
            });
            core.setOutput('sha', pr.data.head.sha);

  e2e-desktop:
    needs: get-pr-ref
    uses: ./.github/workflows/e2e-desktop.yml
    with:
      ref: ${{ needs.get-pr-ref.outputs.ref }}
    secrets: inherit
